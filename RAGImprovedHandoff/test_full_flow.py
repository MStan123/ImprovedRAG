#!/usr/bin/env python3
"""
–ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è get_summary_for_agent()
"""
from chat_history_manager import chat_history
from datetime import datetime

print("=" * 80)
print("üß™ –¢–ï–°–¢: get_summary_for_agent() - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏")
print("=" * 80)

# –û—á–∏—Å—Ç–∫–∞
test_user = "quick_test"
chat_history.clear_history(test_user)

# –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—É—é –∏—Å—Ç–æ—Ä–∏—é
print("\nüìù –°–æ–∑–¥–∞—é —Ç–µ—Å—Ç–æ–≤—É—é –∏—Å—Ç–æ—Ä–∏—é...")
test_messages = [
    ("user", "–ü—Ä–∏–≤–µ—Ç, —á—Ç–æ —Ç–∞–∫–æ–µ Birmarket?"),
    ("assistant", "Birmarket - —ç—Ç–æ –æ–Ω–ª–∞–π–Ω-–º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å –≤ –ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω–µ –¥–ª—è –ø–æ–∫—É–ø–æ–∫ –∏–∑ –¢—É—Ä—Ü–∏–∏."),
    ("user", "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–æ—Å—Ç–∞–≤–∫–∞?"),
    ("assistant",
     "–î–æ—Å—Ç–∞–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫: –º—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã –∏–∑ –¢—É—Ä—Ü–∏–∏ –≤ –ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω, –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏—Ö –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–µ—Ä–µ–¥–∞—ë–º –≤–∞–º."),
    ("user", "–ê —Å–∫–æ–ª—å–∫–æ —ç—Ç–æ —Å—Ç–æ–∏—Ç?"),
    ("assistant", "–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–µ—Å–∞ –ø–æ—Å—ã–ª–∫–∏. –û–±—ã—á–Ω–æ —ç—Ç–æ –æ—Ç 5 –¥–æ 15 –º–∞–Ω–∞—Ç."),
    ("user", "–ú–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –º–æ–π –∑–∞–∫–∞–∑?"),
    ("assistant", "–î–∞, –º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å —á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Birmarket –≤ —Ä–∞–∑–¥–µ–ª–µ '–ú–æ–∏ –∑–∞–∫–∞–∑—ã'."),
    ("user", "–°–ø–∞—Å–∏–±–æ!"),
    ("assistant", "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞! –û–±—Ä–∞—â–∞–π—Ç–µ—Å—å –µ—Å–ª–∏ –±—É–¥—É—Ç –µ—â—ë –≤–æ–ø—Ä–æ—Å—ã."),
]

for role, content in test_messages:
    chat_history.add_message(test_user, role, content)

print(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ {len(test_messages)} —Å–æ–æ–±—â–µ–Ω–∏–π")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã last_n
print("\n" + "=" * 80)

for last_n in [3, 5, 10]:
    print(f"\nüìä –¢–ï–°–¢: last_n = {last_n}")
    print("-" * 80)

    summary = chat_history.get_summary_for_agent(test_user, last_n=last_n)

    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
    message_count = summary.count("üë§") + summary.count("ü§ñ") + summary.count("üéß")

    print(f"–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–π: {message_count}")
    print(f"\n–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:")
    print(summary)
    print("-" * 80)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞
    if message_count == min(last_n, len(test_messages)):
        print(f"‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ü–æ–∫–∞–∑–∞–Ω—ã –ø–æ—Å–ª–µ–¥–Ω–∏–µ {message_count} —Å–æ–æ–±—â–µ–Ω–∏–π")
    else:
        print(f"‚ùå –û–®–ò–ë–ö–ê: –û–∂–∏–¥–∞–ª–æ—Å—å {min(last_n, len(test_messages))}, –ø–æ–ª—É—á–µ–Ω–æ {message_count}")

# –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è
print("\n" + "=" * 80)
print("üìö –ü–û–õ–ù–ê–Ø –ò–°–¢–û–†–ò–Ø (–¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)")
print("=" * 80)

history = chat_history.get_history(test_user)
print(f"\n–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏: {len(history)}")
for i, msg in enumerate(history, 1):
    emoji = {"user": "üë§", "assistant": "ü§ñ", "agent": "üéß"}.get(msg.role, "üí¨")
    print(f"{i}. {emoji} [{msg.timestamp[11:16]}] {msg.content[:50]}...")

# –û—á–∏—Å—Ç–∫–∞
print("\n" + "=" * 80)
cleanup = input("\n–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ? (y/n): ").strip().lower()
if cleanup == 'y':
    chat_history.clear_history(test_user)
    print("‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã")

print("\n" + "=" * 80)
print("‚úÖ –¢–ï–°–¢ –ó–ê–í–ï–†–®–Å–ù")
print("=" * 80)

print("""
üìù –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ:

–ï—Å–ª–∏ –≤—ã –≤–∏–¥–∏—Ç–µ —Ç–æ–ª—å–∫–æ 1 —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ N, —Ç–æ:

1. –û—Ç–∫—Ä–æ–π—Ç–µ: chat_history_manager.py

2. –ù–∞–π–¥–∏—Ç–µ –º–µ—Ç–æ–¥ get_summary_for_agent (–æ–∫–æ–ª–æ —Å—Ç—Ä–æ–∫–∏ 180)

3. –ó–∞–º–µ–Ω–∏—Ç–µ —Å—Ç—Ä–æ–∫—É:
   recent_messages = history[-last_n:] if len(history) > last_n else history

4. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤ —Ü–∏–∫–ª–µ –ù–ï–¢ break –∏–ª–∏ return —Ä–∞–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏

5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ lines.append –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –ö–ê–ñ–î–û–ì–û —Å–æ–æ–±—â–µ–Ω–∏—è

6. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ chat_server.py

7. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Ç–µ—Å—Ç —Å–Ω–æ–≤–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
""")